<VirtualHost *:81>
 ServerName unified-origin-backend

 LogFormat {{LOG_FORMAT}} log_format

 CustomLog /dev/stdout log_format
 ErrorLog /dev/stderr

 LogLevel {{LOG_LEVEL}}

 SSLProxyEngine on

<Location "/">
   UspHandleIsm on
   UspEnableSubreq on
   IsmProxyPass http://localhost:81/load-balancer/
 </Location>

 <Location "/load-balancer/">
   ProxyPass "balancer://load-balancer/"
   ProxyPassReverse "balancer://load-balancer/"
 </Location>

 <Proxy "balancer://load-balancer/">
   ProxySet lbmethod=bybusyness failonstatus=403 failontimeout=On forcerecovery=Off nofailover=Off

   # Primary 2 Node Cluster
   BalancerMember "http://localhost:81/{{REMOTE_STORAGE_LOCATION_A}}" connectiontimeout=5 timeout=5 ttl=300 keepalive=on retry=60  hcmethod=GET hcuri={{HEALTH_CHECK}} hcinterval=30 hcpasses=1 hcfails=1
   BalancerMember "http://localhost:81/{{REMOTE_STORAGE_LOCATION_B}}" connectiontimeout=5 timeout=5 ttl=300 keepalive=on retry=60 hcmethod=GET  hcuri={{HEALTH_CHECK}} hcinterval=30 hcpasses=1 hcfails=1

 </Proxy>

 # Enable For Balancer Monitoring UI
 #<Location "/balancer-manager">
 #  SetHandler balancer-manager
 #</Location>

<Location "/{{REMOTE_STORAGE_LOCATION_A}}">
  ProxyPass "{{REMOTE_STORAGE_URL_A}}"
  ProxyPassReverse "{{REMOTE_STORAGE_URL_A}}"
</Location>

<Proxy "{{REMOTE_STORAGE_URL_A}}">
    ProxySet connectiontimeout=5 timeout=5 ttl=300 keepalive=on retry=0 timeout=5 ttl=300
</Proxy>

<Location "/{{REMOTE_STORAGE_LOCATION_B}}">
  ProxyPass "{{REMOTE_STORAGE_URL_B}}"
  ProxyPassReverse "{{REMOTE_STORAGE_URL_B}}"
</Location>

<Proxy "{{REMOTE_STORAGE_URL_B}}">
    ProxySet connectiontimeout=5 timeout=5 ttl=300 keepalive=on retry=0 timeout=5 ttl=300
</Proxy>

</VirtualHost>
